<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu.kh.project.accommodation.mapper.AccommodationMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="accommodationResultMap" type="AccommodationDTO">
        <id property="accommodationNo" column="ACCOMMODATION_NO"/>
        <result property="tourApiId" column="TOUR_API_ID"/>
        <result property="name" column="NAME"/>
        <result property="address" column="ADDRESS"/>
        <result property="phone" column="PHONE"/>
        <result property="priceMin" column="PRICE_MIN"/>
        <result property="priceMax" column="PRICE_MAX"/>
        <result property="checkInTime" column="CHECK_IN_TIME"/>
        <result property="checkOutTime" column="CHECK_OUT_TIME"/>
        <result property="facilities" column="FACILITIES"/>
        <result property="accommodationType" column="ACCOMMODATION_TYPE"/>
        <result property="region" column="REGION"/>
        <result property="latitude" column="LATITUDE"/>
        <result property="longitude" column="LONGITUDE"/>
        <result property="recommendationReason" column="RECOMMENDATION_REASON"/>
        <result property="thumbnailUrl" column="THUMBNAIL_URL"/>
        <result property="viewCount" column="VIEW_COUNT"/>
        <result property="status" column="STATUS"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
    </resultMap>

    <!-- API ID로 숙소 존재 여부 확인 -->
    <select id="existsByTourApiId" parameterType="String" resultType="int">
        SELECT COUNT(*)
        FROM ACCOMMODATION
        WHERE TOUR_API_ID = #{tourApiId}
    </select>

    <!-- 숙소 등록 -->
    <insert id="insertAccommodation" parameterType="AccommodationDTO">
        INSERT INTO ACCOMMODATION (
            ACCOMMODATION_NO, 
            NAME, 
            ADDRESS, 
            PHONE,
            ACCOMMODATION_TYPE,
            REGION,
            LATITUDE,
            LONGITUDE,
            TOUR_API_ID,
            STATUS,
            CREATED_AT
        ) VALUES (
            SEQ_ACCOM_NO.NEXTVAL,
            #{name},
            #{address},
            #{phone},
            #{accommodationType},
            #{region},
            #{latitude},
            #{longitude},
            #{tourApiId},
            #{status},
            SYSDATE
        )
    </insert>

    <!-- 숙소 목록 조회 (페이징) -->
    <select id="selectAccommodationList" resultMap="accommodationResultMap">
        SELECT * FROM (
            SELECT 
                a.*,
                ROW_NUMBER() OVER (ORDER BY CREATED_AT DESC) AS rn
            FROM ACCOMMODATION a
            WHERE STATUS = 'A'
            <if test="region != null and region != ''">
                AND REGION = #{region}
            </if>
        )
        WHERE rn BETWEEN #{offset} + 1 AND #{offset} + #{limit}
    </select>

    <!-- 숙소 상세 조회 -->
    <select id="selectAccommodationByNo" parameterType="long" resultMap="accommodationResultMap">
        SELECT *
        FROM ACCOMMODATION
        WHERE ACCOMMODATION_NO = #{accommodationNo}
    </select>

    <!-- 총 개수 조회 -->
    <select id="selectTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM ACCOMMODATION
        WHERE STATUS = 'A'
        <if test="region != null and region != ''">
            AND REGION = #{region}
        </if>
    </select>

    <!-- 기존 데이터 숙소 유형 재분류 -->
    <update id="reclassifyAccommodationTypes">
        UPDATE ACCOMMODATION SET ACCOMMODATION_TYPE =
            CASE
                WHEN LOWER(NAME) LIKE '%호텔%' OR LOWER(NAME) LIKE '%hotel%' THEN '호텔'
                WHEN LOWER(NAME) LIKE '%리조트%' OR LOWER(NAME) LIKE '%resort%' THEN '리조트'
                WHEN LOWER(NAME) LIKE '%펜션%' OR LOWER(NAME) LIKE '%pension%' THEN '펜션'
                WHEN LOWER(NAME) LIKE '%풀빌라%' OR LOWER(NAME) LIKE '%pool villa%' THEN '풀빌라'
                WHEN LOWER(NAME) LIKE '%게스트하우스%' OR LOWER(NAME) LIKE '%guesthouse%' OR LOWER(NAME) LIKE '%guest house%' THEN '게스트하우스'
                WHEN LOWER(NAME) LIKE '%호스텔%' OR LOWER(NAME) LIKE '%hostel%' THEN '호스텔'
                WHEN LOWER(NAME) LIKE '%한옥%' THEN '한옥'
                WHEN LOWER(NAME) LIKE '%모텔%' THEN '모텔'
                WHEN LOWER(NAME) LIKE '%민박%' THEN '민박'
                ELSE '민박'
            END
        WHERE STATUS = 'A'
    </update>

</mapper>