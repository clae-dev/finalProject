<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.kh.project.member.mapper.MemberMapper">

    <!-- ResultMap: MEMBER 테이블 -> MemberDTO 매핑 -->
    <resultMap id="memberResultMap" type="edu.kh.project.member.dto.MemberDTO">
        <id property="memberNo" column="MEMBER_NO" />
        <result property="memberEmail" column="EMAIL" />
        <result property="memberPw" column="PASSWORD" />
        <result property="memberNickname" column="NICKNAME" />
        <result property="memberName" column="NAME" />
        <result property="memberPhone" column="PHONE" />
        <result property="memberGender" column="GENDER" />
        <result property="memberAgeGroup" column="AGE_RANGE" />
        <result property="memberProfileImg" column="PROFILE_IMAGE" />
        <result property="memberIntro" column="INTRO" />
        <result property="memberRole" column="MEMBER_TYPE" />
        <result property="memberStatus" column="STATUS" />
        <result property="emailVerified" column="EMAIL_VERIFIED" />
        <result property="createdAt" column="CREATED_AT" />
        <result property="updatedAt" column="UPDATED_AT" />
    </resultMap>

    <!-- 이메일로 회원 조회 (로그인용 - 비밀번호 포함) -->
    <select id="selectMemberByEmail" resultMap="memberResultMap">
        SELECT
            MEMBER_NO,
            EMAIL,
            PASSWORD,
            NICKNAME,
            NAME,
            PROFILE_IMAGE,
            MEMBER_TYPE,
            STATUS,
            EMAIL_VERIFIED
        FROM MEMBER
        WHERE EMAIL = #{memberEmail}
          AND STATUS = 'A'
    </select>

    <!-- 회원 번호로 회원 조회 -->
    <select id="selectMemberByNo" resultMap="memberResultMap">
        SELECT
            MEMBER_NO,
            EMAIL,
            NICKNAME,
            NAME,
            PHONE,
            GENDER,
            AGE_RANGE,
            PROFILE_IMAGE,
            INTRO,
            MEMBER_TYPE,
            STATUS,
            EMAIL_VERIFIED,
            CREATED_AT
        FROM MEMBER
        WHERE MEMBER_NO = #{memberNo}
    </select>

    <!-- 이메일 중복 확인 -->
    <select id="checkEmailDuplicate" resultType="int">
        SELECT COUNT(*)
        FROM MEMBER
        WHERE EMAIL = #{memberEmail}
          AND STATUS != 'W'
    </select>

    <!-- 닉네임 중복 확인 -->
    <select id="checkNicknameDuplicate" resultType="int">
        SELECT COUNT(*)
        FROM MEMBER
        WHERE NICKNAME = #{memberNickname}
          AND STATUS != 'W'
    </select>

    <!-- 회원가입 -->
    <insert id="insertMember">
        INSERT INTO MEMBER (
            MEMBER_NO,
            EMAIL,
            PASSWORD,
            NICKNAME,
            NAME,
            PHONE,
            GENDER,
            AGE_RANGE,
            MEMBER_TYPE,
            STATUS,
            EMAIL_VERIFIED
        ) VALUES (
            SEQ_MEMBER_NO.NEXTVAL,
            #{memberEmail},
            #{memberPw},
            #{memberNickname},
            #{memberName},
            #{memberPhone},
            #{memberGender},
            #{memberAgeGroup},
            'U',
            'A',
            'Y'
        )
    </insert>

    <!-- 회원 정보 수정 -->
    <update id="updateMember">
        UPDATE MEMBER
        SET
            NICKNAME = #{memberNickname},
            PHONE = #{memberPhone},
            PROFILE_IMAGE = #{memberProfileImg},
            INTRO = #{memberIntro},
            UPDATED_AT = SYSDATE
        WHERE MEMBER_NO = #{memberNo}
    </update>

    <!-- 회원 탈퇴 (상태 변경) -->
    <update id="withdrawMember">
        UPDATE MEMBER
        SET
            STATUS = 'W',
            UPDATED_AT = SYSDATE
        WHERE MEMBER_NO = #{memberNo}
    </update>

    <!-- 이메일 인증 완료 처리 -->
    <update id="updateEmailVerified">
        UPDATE MEMBER
        SET EMAIL_VERIFIED = 'Y'
        WHERE EMAIL = #{memberEmail}
    </update>

    <!-- 아이디 찾기 (이름 + 이메일) -->
    <select id="findId" resultMap="memberResultMap">
        SELECT
            EMAIL,
            CREATED_AT
        FROM MEMBER
        WHERE NAME = #{memberName}
          AND EMAIL = #{memberEmail}
          AND STATUS = 'A'
    </select>

    <!-- 비밀번호 찾기 (이메일 + 이름) -->
    <select id="findPw" resultMap="memberResultMap">
        SELECT
            MEMBER_NO,
            EMAIL,
            NAME
        FROM MEMBER
        WHERE EMAIL = #{memberEmail}
          AND NAME = #{memberName}
          AND STATUS = 'A'
    </select>

    <!-- 비밀번호 재설정 -->
    <update id="resetPw">
        UPDATE MEMBER
        SET
            PASSWORD = #{memberPw},
            UPDATED_AT = SYSDATE
        WHERE EMAIL = #{memberEmail}
    </update>

</mapper>
