<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.kh.project.member.mapper.MemberMapper">

    <!-- ResultMap: MEMBER 테이블 -> MemberDTO 매핑 -->
    <resultMap id="memberResultMap" type="edu.kh.project.member.dto.MemberDTO">
        <id property="memberNo" column="MEMBER_NO" />
        <result property="memberEmail" column="MEMBER_EMAIL" />
        <result property="memberPw" column="MEMBER_PW" />
        <result property="memberNickname" column="MEMBER_NICKNAME" />
        <result property="memberName" column="MEMBER_NAME" />
        <result property="memberPhone" column="MEMBER_PHONE" />
        <result property="memberGender" column="MEMBER_GENDER" />
        <result property="memberAgeGroup" column="MEMBER_AGE_GROUP" />
        <result property="memberProfileImg" column="MEMBER_PROFILE_IMG" />
        <result property="memberIntro" column="MEMBER_INTRO" />
        <result property="memberRole" column="MEMBER_ROLE" />
        <result property="memberStatus" column="MEMBER_STATUS" />
        <result property="emailVerified" column="EMAIL_VERIFIED" />
        <result property="createdAt" column="CREATED_AT" />
        <result property="updatedAt" column="UPDATED_AT" />
        <result property="withdrawnAt" column="WITHDRAWN_AT" />
    </resultMap>

    <!-- 이메일로 회원 조회 (로그인용 - 비밀번호 포함) -->
    <select id="selectMemberByEmail" resultMap="memberResultMap">
        SELECT 
            MEMBER_NO,
            MEMBER_EMAIL,
            MEMBER_PW,
            MEMBER_NICKNAME,
            MEMBER_NAME,
            MEMBER_PROFILE_IMG,
            MEMBER_ROLE,
            MEMBER_STATUS,
            EMAIL_VERIFIED
        FROM MEMBER
        WHERE MEMBER_EMAIL = #{memberEmail}
          AND MEMBER_STATUS = 'ACTIVE'
    </select>

    <!-- 회원 번호로 회원 조회 -->
    <select id="selectMemberByNo" resultMap="memberResultMap">
        SELECT 
            MEMBER_NO,
            MEMBER_EMAIL,
            MEMBER_NICKNAME,
            MEMBER_NAME,
            MEMBER_PHONE,
            MEMBER_GENDER,
            MEMBER_AGE_GROUP,
            MEMBER_PROFILE_IMG,
            MEMBER_INTRO,
            MEMBER_ROLE,
            MEMBER_STATUS,
            EMAIL_VERIFIED,
            CREATED_AT
        FROM MEMBER
        WHERE MEMBER_NO = #{memberNo}
    </select>

    <!-- 이메일 중복 확인 -->
    <select id="checkEmailDuplicate" resultType="int">
        SELECT COUNT(*)
        FROM MEMBER
        WHERE MEMBER_EMAIL = #{memberEmail}
          AND MEMBER_STATUS != 'WITHDRAWN'
    </select>

    <!-- 닉네임 중복 확인 -->
    <select id="checkNicknameDuplicate" resultType="int">
        SELECT COUNT(*)
        FROM MEMBER
        WHERE MEMBER_NICKNAME = #{memberNickname}
          AND MEMBER_STATUS != 'WITHDRAWN'
    </select>

    <!-- 회원가입 -->
    <insert id="insertMember">
        INSERT INTO MEMBER (
            MEMBER_NO,
            MEMBER_EMAIL,
            MEMBER_PW,
            MEMBER_NICKNAME,
            MEMBER_NAME,
            MEMBER_PHONE,
            MEMBER_GENDER,
            MEMBER_AGE_GROUP,
            MEMBER_ROLE,
            MEMBER_STATUS,
            EMAIL_VERIFIED
        ) VALUES (
            SEQ_MEMBER_NO.NEXTVAL,
            #{memberEmail},
            #{memberPw},
            #{memberNickname},
            #{memberName},
            #{memberPhone},
            #{memberGender},
            #{memberAgeGroup},
            'USER',
            'ACTIVE',
            'Y'
        )
    </insert>

    <!-- 회원 정보 수정 -->
    <update id="updateMember">
        UPDATE MEMBER
        SET
            MEMBER_NICKNAME = #{memberNickname},
            MEMBER_PHONE = #{memberPhone},
            MEMBER_PROFILE_IMG = #{memberProfileImg},
            MEMBER_INTRO = #{memberIntro},
            UPDATED_AT = SYSDATE
        WHERE MEMBER_NO = #{memberNo}
    </update>

    <!-- 회원 탈퇴 (상태 변경) -->
    <update id="withdrawMember">
        UPDATE MEMBER
        SET
            MEMBER_STATUS = 'WITHDRAWN',
            WITHDRAWN_AT = SYSDATE
        WHERE MEMBER_NO = #{memberNo}
    </update>

    <!-- 이메일 인증 완료 처리 -->
    <update id="updateEmailVerified">
        UPDATE MEMBER
        SET EMAIL_VERIFIED = 'Y'
        WHERE MEMBER_EMAIL = #{memberEmail}
    </update>

    <!-- 아이디 찾기 (이름 + 이메일) -->
    <select id="findId" resultMap="memberResultMap">
        SELECT 
            MEMBER_EMAIL,
            CREATED_AT
        FROM MEMBER
        WHERE MEMBER_NAME = #{memberName}
          AND MEMBER_EMAIL = #{memberEmail}
          AND MEMBER_STATUS = 'ACTIVE'
    </select>

    <!-- 비밀번호 찾기 (이메일 + 이름) -->
    <select id="findPw" resultMap="memberResultMap">
        SELECT 
            MEMBER_NO,
            MEMBER_EMAIL,
            MEMBER_NAME
        FROM MEMBER
        WHERE MEMBER_EMAIL = #{memberEmail}
          AND MEMBER_NAME = #{memberName}
          AND MEMBER_STATUS = 'ACTIVE'
    </select>

    <!-- 비밀번호 재설정 -->
    <update id="resetPw">
        UPDATE MEMBER
        SET 
            MEMBER_PW = #{memberPw},
            UPDATED_AT = SYSDATE
        WHERE MEMBER_EMAIL = #{memberEmail}
    </update>

</mapper>